@page "/admincourses"
@inject AuthStateService AuthStateService
@inject GradesService GradesService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Thesis - Manage Courses</PageTitle>

@if (!isAuthChecked)
{
    <div class="loading-container">
        <div class="spinner"></div>
        <p>Loading Course Management...</p>
    </div>
}
else if (!isAuthorized)
{
    <div class="unauthorized-container">
        <div class="unauthorized-card">
            <div class="unauthorized-icon">🚫</div>
            <h3>Access Denied</h3>
            <p>You don't have permission to manage courses.</p>
            <button class="btn btn-primary" @onclick="RedirectToHome">Return to Home</button>
        </div>
    </div>
}
else
{
    <div class="admin-courses">
        <div class="header-bar">
            <button class="back-btn" @onclick="GoBack">← Back to Dashboard</button>
            <h2>Manage Courses</h2>
            <div class="info-badge">
                @Courses.Count courses
            </div>
        </div>

        @if (isLoading)
        {
            <div class="loading">Loading courses data...</div>
        }
        else
        {
            <div class="courses-container">
                <!-- Course Form Section -->
                <div class="form-section">
                    <h4>@(EditingCourse?.Id == 0 ? "Create New Course" : "Edit Course")</h4>

                    <div class="form-field">
                        <label>Course Name:</label>
                        <input type="text" @bind="EditingCourse.Name" placeholder="Enter course name" />
                    </div>

                    <div class="form-field">
                        <label>Description:</label>
                        <textarea @bind="EditingCourse.Description" placeholder="Enter course description" rows="3"></textarea>
                    </div>

                    <div class="form-field">
                        <label>Professor:</label>
                        <select @bind="EditingCourse.ProfessorId">
                            <option value="0">-- Select Professor --</option>
                            @foreach (var professor in Professors)
                            {
                                <option value="@professor.Id">@professor.Name @professor.LastName</option>
                            }
                        </select>
                    </div>

                    <!-- Grading Method Display (Read-only) -->
                    <div class="form-field">
                        <label>Grading Method:</label>
                        <div class="grading-method-display">
                            @if (EditingCourse.GradingMethod.HasValue)
                            {
                                <span class="grading-method @EditingCourse.GradingMethod.Value.ToString().ToLower()">
                                    @EditingCourse.GradingMethod.Value
                                </span>
                                <small>Set by professor</small>
                            }
                            else
                            {
                                <span class="no-method">Not set yet</span>
                                <small>Professor will set grading method</small>
                            }
                        </div>
                    </div>

                    <!-- Schedule Section -->
                    <div class="schedule-section">
                        <h5>Course Schedule</h5>
                        @foreach (var schedule in EditingCourseSchedules)
                        {
                            <div class="schedule-item">
                                <div class="schedule-row">
                                    <select @bind="schedule.DayOfWeek" class="day-select">
                                        <option value="Monday">Monday</option>
                                        <option value="Tuesday">Tuesday</option>
                                        <option value="Wednesday">Wednesday</option>
                                        <option value="Thursday">Thursday</option>
                                        <option value="Friday">Friday</option>
                                        <option value="Saturday">Saturday</option>
                                        <option value="Sunday">Sunday</option>
                                    </select>
                                    <input type="time" @bind="schedule.StartTime" class="time-input" />
                                    <span>to</span>
                                    <input type="time" @bind="schedule.EndTime" class="time-input" />
                                    <input type="text" @bind="schedule.Room" placeholder="Room" class="room-input" />
                                    <button type="button" class="remove-btn" @onclick="() => RemoveSchedule(schedule)">×</button>
                                </div>
                            </div>
                        }
                        <button type="button" class="add-schedule-btn" @onclick="AddSchedule">+ Add Schedule</button>
                    </div>

                    <div class="form-actions">
                        <button class="save-btn" @onclick="SaveCourse" disabled="@(!IsFormValid())">
                            @(EditingCourse.Id == 0 ? "Create Course" : "Update Course")
                        </button>
                        @if (EditingCourse.Id != 0)
                        {
                            <button class="cancel-btn" @onclick="CancelEdit">Cancel</button>
                        }
                        <button class="clear-btn" @onclick="ClearForm">Clear Form</button>
                    </div>
                </div>

                <!-- Courses List Section -->
                <div class="courses-list-section">
                    <div class="section-header">
                        <h3>All Courses (@Courses.Count)</h3>
                        <div class="search-box">
                            <input type="text" @bind="searchTerm" @oninput="OnSearch" placeholder="Search courses..." />
                        </div>
                    </div>

                    <!-- Statistics section removed here -->

                    <div class="courses-grid">
                        @foreach (var course in FilteredCourses)
                        {
                            <div class="course-card">
                                <div class="course-header">
                                    <h4>@course.Name</h4>
                                    <div class="course-actions">
                                        <button class="edit-btn" @onclick="() => EditCourse(course)" title="Edit course">✏️</button>
                                        <button class="delete-btn" @onclick="() => DeleteCourse(course.Id)" title="Delete course">🗑️</button>
                                    </div>
                                </div>

                                <div class="course-details">
                                    <div class="detail-item">
                                        <span class="label">Description:</span>
                                        <span class="value">@(course.Description ?? "No description")</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="label">Professor:</span>
                                        <span class="value">@GetProfessorName(course.ProfessorId)</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="label">Grading Method:</span>
                                        <span class="value">
                                            @if (course.GradingMethod.HasValue)
                                            {
                                                <span class="grading-method @course.GradingMethod.Value.ToString().ToLower()">
                                                    @course.GradingMethod.Value
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="no-method">Not set by professor yet</span>
                                            }
                                        </span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="label">Difficulty Score:</span>
                                        <div class="difficulty-stars">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                <span class="star @(i <= course.DifficultyRating ? "filled" : "")">★</span>
                                            }
                                            <span class="difficulty-value">(@course.DifficultyRating.ToString("0.0"))</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Schedule Display -->
                                <div class="course-schedule">
                                    <h5>Schedule:</h5>
                                    @if (GetCourseSchedules(course.Id).Any())
                                    {
                                        @foreach (var schedule in GetCourseSchedules(course.Id))
                                        {
                                            <div class="schedule-display">
                                                <span class="schedule-day">@schedule.DayOfWeek</span>
                                                <span class="schedule-time">@schedule.StartTime.ToString("HH:mm") - @schedule.EndTime.ToString("HH:mm")</span>
                                                <span class="schedule-room">@(string.IsNullOrEmpty(schedule.Room) ? "No room" : schedule.Room)</span>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="no-schedule">No schedule set</div>
                                    }
                                </div>

                                <div class="course-meta">
                                    <small>Course ID: @course.Id</small>
                                    @if (course.GradingMethod.HasValue)
                                    {
                                        <small>Method set by professor</small>
                                    }
                                </div>
                            </div>
                        }
                    </div>

                    @if (!FilteredCourses.Any())
                    {
                        <div class="no-courses">
                            <p>No courses found</p>
                            @if (!string.IsNullOrEmpty(searchTerm))
                            {
                                <p>Try adjusting your search terms</p>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    </div>
}

@code {
    private bool isAuthorized = false;
    private bool isAuthChecked = false;
    private bool isLoading = false;
    private string searchTerm = "";

    private List<Course> Courses = new();
    private List<Course> FilteredCourses = new();
    private List<User> Professors = new();
    private List<Schedule> AllSchedules = new();
    private Course EditingCourse = new();
    private List<Schedule> EditingCourseSchedules = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await AuthStateService.InitializeAsync();
            var user = AuthStateService.CurrentUser;

            isAuthorized = user != null && user.Role == "Admin";
            isAuthChecked = true;

            if (isAuthorized)
            {
                await LoadDataAsync();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing: {ex.Message}");
            isAuthChecked = true;
        }
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            Console.WriteLine("Loading courses from database...");

            var coursesTask = GradesService.GetCoursesAsync();
            var professorsTask = GradesService.GetProfessorsAsync();
            var schedulesTask = GradesService.GetSchedulesAsync();

            await Task.WhenAll(coursesTask, professorsTask, schedulesTask);

            Courses = await coursesTask ?? new List<Course>();
            Professors = await professorsTask ?? new List<User>();
            AllSchedules = await schedulesTask ?? new List<Schedule>();

            FilteredCourses = Courses;

            Console.WriteLine($"Loaded {Courses.Count} courses, {Professors.Count} professors, {AllSchedules.Count} schedules");

            // Log course details for debugging
            foreach (var course in Courses)
            {
                Console.WriteLine($"Course: {course.Id} - {course.Name} - GradingMethod: {course.GradingMethod}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", $"Error loading courses: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void AddSchedule()
    {
        EditingCourseSchedules.Add(new Schedule
        {
            DayOfWeek = "Monday",
            StartTime = new TimeOnly(9, 0),
            EndTime = new TimeOnly(10, 30),
            Room = ""
        });
        StateHasChanged();
    }

    private void RemoveSchedule(Schedule schedule)
    {
        EditingCourseSchedules.Remove(schedule);
        StateHasChanged();
    }

    private List<Schedule> GetCourseSchedules(int courseId)
    {
        return AllSchedules.Where(s => s.CourseId == courseId).ToList();
    }

    private string GetProfessorName(int professorId)
    {
        var professor = Professors.FirstOrDefault(p => p.Id == professorId);
        return professor != null ? $"{professor.Name} {professor.LastName}" : "Unknown Professor";
    }

    private void EditCourse(Course course)
    {
        EditingCourse = new Course
        {
            Id = course.Id,
            Name = course.Name,
            Description = course.Description,
            ProfessorId = course.ProfessorId,
            GradingMethod = course.GradingMethod, // Keep existing grading method
            DifficultyRating = course.DifficultyRating
        };

        // Load existing schedules for this course
        EditingCourseSchedules = GetCourseSchedules(course.Id).Select(s => new Schedule
        {
            Id = s.Id,
            CourseId = s.CourseId,
            DayOfWeek = s.DayOfWeek,
            StartTime = s.StartTime,
            EndTime = s.EndTime,
            Room = s.Room
        }).ToList();

        StateHasChanged();
    }

    private void CancelEdit()
    {
        EditingCourse = new Course();
        EditingCourseSchedules = new List<Schedule>();
        StateHasChanged();
    }

    private void ClearForm()
    {
        EditingCourse = new Course();
        EditingCourseSchedules = new List<Schedule>();
        StateHasChanged();
    }

    private async Task SaveCourse()
    {
        if (!IsFormValid()) return;

        try
        {
            // When creating a new course, set GradingMethod to null
            if (EditingCourse.Id == 0)
            {
                EditingCourse.GradingMethod = null; // Set to null for new courses
                await GradesService.AddCourseAsync(EditingCourse);

                // Add schedules for new course
                foreach (var schedule in EditingCourseSchedules)
                {
                    schedule.CourseId = EditingCourse.Id;
                    await GradesService.AddScheduleAsync(schedule);
                }
            }
            else
            {
                // For existing courses, preserve the existing GradingMethod
                var existingCourse = Courses.FirstOrDefault(c => c.Id == EditingCourse.Id);
                if (existingCourse != null)
                {
                    EditingCourse.GradingMethod = existingCourse.GradingMethod;
                }

                await GradesService.UpdateCourseAsync(EditingCourse);

                // Update schedules for existing course
                var existingSchedules = GetCourseSchedules(EditingCourse.Id);

                // Remove old schedules
                foreach (var existing in existingSchedules)
                {
                    await GradesService.DeleteScheduleAsync(existing.Id);
                }

                // Add new schedules
                foreach (var schedule in EditingCourseSchedules)
                {
                    schedule.CourseId = EditingCourse.Id;
                    await GradesService.AddScheduleAsync(schedule);
                }
            }

            await LoadDataAsync();
            ClearForm();

            
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving course: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", $"Error saving course: {ex.Message}");
        }
    }

    private async Task DeleteCourse(int courseId)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this course? This action cannot be undone.");
        if (!confirmed) return;

        try
        {
            await GradesService.DeleteCourseAsync(courseId);
            await LoadDataAsync();
            
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting course: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", $"Error deleting course: {ex.Message}");
        }
    }

    private void OnSearch(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";
        FilterCourses();
    }

    private void FilterCourses()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            FilteredCourses = Courses;
        }
        else
        {
            var term = searchTerm.ToLower();
            FilteredCourses = Courses.Where(c =>
                c.Name.ToLower().Contains(term) ||
                (c.Description != null && c.Description.ToLower().Contains(term)) ||
                GetProfessorName(c.ProfessorId).ToLower().Contains(term)
            ).ToList();
        }
    }

    private bool IsFormValid()
    {
        return !string.IsNullOrWhiteSpace(EditingCourse.Name) &&
               EditingCourse.ProfessorId > 0 &&
               EditingCourseSchedules.All(s =>
                   !string.IsNullOrWhiteSpace(s.DayOfWeek) &&
                   s.StartTime != default &&
                   s.EndTime != default &&
                   s.EndTime > s.StartTime
               );
    }

    private void GoBack() => Navigation.NavigateTo("/adminhome");
    private void RedirectToHome() => Navigation.NavigateTo("/");
}

<style>
    .admin-courses {
        min-height: 100vh;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 30px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }

    .header-bar {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 30px;
        background: white;
        padding: 20px 30px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    }

        .header-bar h2 {
            color: #2d3748;
            font-size: 1.8rem;
            font-weight: 600;
            margin: 0;
        }

    .info-badge {
        margin-left: auto;
        background: #667eea;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .back-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

    .courses-container {
        display: grid;
        grid-template-columns: 400px 1fr;
        gap: 30px;
    }

    .form-section {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        height: fit-content;
        position: sticky;
        top: 30px;
    }

        .form-section h4 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

    .form-field {
        margin-bottom: 20px;
    }

        .form-field label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        .form-field input,
        .form-field select,
        .form-field textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.3s ease;
        }

            .form-field input:focus,
            .form-field select:focus,
            .form-field textarea:focus {
                outline: none;
                border-color: #667eea;
            }

    .grading-methods {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .radio-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 8px;
        border-radius: 6px;
        transition: background-color 0.2s ease;
    }

        .radio-label:hover {
            background: #f7fafc;
        }

        .radio-label input[type="radio"] {
            margin: 0;
        }

    .schedule-section {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }

        .schedule-section h5 {
            margin: 0 0 15px 0;
            color: #2d3748;
        }

    .schedule-item {
        margin-bottom: 10px;
    }

    .schedule-row {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .day-select {
        width: 120px;
    }

    .time-input {
        width: 100px;
    }

    .room-input {
        width: 80px;
    }

    .remove-btn {
        background: #fc8181;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .add-schedule-btn {
        background: #e2e8f0;
        color: #4a5568;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .form-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .save-btn, .cancel-btn, .clear-btn {
        padding: 10px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
    }

    .save-btn {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
        flex: 1;
    }

        .save-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

    .cancel-btn {
        background: #e2e8f0;
        color: #4a5568;
    }

    .clear-btn {
        background: #f7fafc;
        color: #4a5568;
        border: 1px solid #e2e8f0;
    }

    .courses-list-section {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

        .section-header h3 {
            color: #2d3748;
            margin: 0;
        }

    .search-box input {
        padding: 8px 12px;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        width: 250px;
    }

    .courses-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
    }

    .course-card {
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 20px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

        .course-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

    .course-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
    }

        .course-header h4 {
            margin: 0;
            color: #2d3748;
            font-size: 1.1rem;
        }

    .course-actions {
        display: flex;
        gap: 5px;
    }

    .edit-btn, .delete-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.1rem;
        padding: 5px;
    }

        .edit-btn:hover {
            color: #4299e1;
        }

        .delete-btn:hover {
            color: #f56565;
        }

    .course-details {
        margin-bottom: 15px;
    }

    .detail-item {
        display: flex;
        margin-bottom: 8px;
    }

        .detail-item .label {
            font-weight: 600;
            color: #4a5568;
            min-width: 120px;
        }

        .detail-item .value {
            color: #2d3748;
            flex: 1;
        }

    .grading-method {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }

        .grading-method.exam {
            background: #fed7d7;
            color: #c53030;
        }

        .grading-method.exercise {
            background: #c6f6d5;
            color: #276749;
        }

        .grading-method.both {
            background: #bee3f8;
            color: #2c5282;
        }

    .difficulty-stars {
        display: flex;
        align-items: center;
        gap: 2px;
    }

    .star {
        color: #e2e8f0;
        font-size: 1.1rem;
    }

        .star.filled {
            color: #f6ad55;
        }

    .difficulty-value {
        margin-left: 8px;
        color: #718096;
        font-size: 0.9rem;
    }

    .course-schedule {
        border-top: 1px solid #f1f5f9;
        padding-top: 15px;
    }

        .course-schedule h5 {
            margin: 0 0 10px 0;
            color: #4a5568;
            font-size: 0.9rem;
        }

    .schedule-display {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 0;
        border-bottom: 1px solid #f7fafc;
    }

    .schedule-day {
        font-weight: 600;
        color: #2d3748;
        min-width: 80px;
    }

    .schedule-time {
        color: #718096;
        flex: 1;
        text-align: center;
    }

    .schedule-room {
        color: #a0aec0;
        font-size: 0.9rem;
    }

    .no-schedule {
        color: #a0aec0;
        font-style: italic;
        text-align: center;
        padding: 10px;
    }

    .no-courses {
        text-align: center;
        padding: 40px;
        color: #718096;
    }

    .loading {
        text-align: center;
        padding: 40px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    }

    @@media (max-width: 1024px) {
        .courses-container {
            grid-template-columns: 1fr;
        }

        .form-section {
            position: static;
        }
    }

    @@media (max-width: 768px) {
        .schedule-row {
            flex-direction: column;
            align-items: stretch;
        }

        .day-select,
        .time-input,
        .room-input {
            width: 100%;
        }

        .section-header {
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
        }

        .search-box input {
            width: 100%;
        }
    }
</style>