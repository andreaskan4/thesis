@page "/adminusers"
@inject NavigationManager Navigation
@using Thesis.Data
@inject AppDbContext DbContext
@inject IJSRuntime JSRuntime

<PageTitle>Admin - User Management</PageTitle>

<div class="admin-users-page">
    <div class="page-header">
        <h2>User Management</h2>
        <button class="btn btn-primary" @onclick="ShowAddUserModal">Add User</button>
    </div>

    <div class="user-table-container">
        <table class="user-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Last Name</th>
                    <th>Email</th>
                    <th>Academic ID</th>
                    <th>Role</th>
                    <th>Cafeteria Worker</th>
                    <th>Created At</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in users)
                {
                    var isCafeteriaWorker = cafeteriaWorkers.Any(cw => cw.StudentId == user.Id && cw.IsActive);
                    <tr>
                        <td>@user.Id</td>
                        <td>@user.Name</td>
                        <td>@user.LastName</td>
                        <td>@user.Email</td>
                        <td>@user.AcademicId</td>
                        <td>
                            <span class="role-badge role-@user.Role.ToLower()">@user.Role</span>
                        </td>
                        <td>
                            @if (user.Role == "Student")
                            {
                                <div class="cafeteria-worker-toggle">
                                    @if (isCafeteriaWorker)
                                    {
                                        <span class="worker-status active">👨‍🍳 Active</span>
                                        <button class="btn btn-sm btn-warning" @onclick="() => RemoveCafeteriaWorker(user)">
                                            Remove
                                        </button>
                                    }
                                    else
                                    {
                                        <span class="worker-status inactive">Not Worker</span>
                                        <button class="btn btn-sm btn-success" @onclick="() => AddCafeteriaWorker(user)">
                                            Make Worker
                                        </button>
                                    }
                                </div>
                            }
                            else
                            {
                                <span class="worker-status na">N/A</span>
                            }
                        </td>
                        <td>@user.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-outline" @onclick="() => ShowEditUserModal(user)">Edit</button>
                                <button class="btn btn-sm btn-danger" @onclick="() => ShowDeleteUserModal(user)">Delete</button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Edit User Modal -->
@if (showUserModal)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>@(isEditing ? "Edit User" : "Add User")</h3>
                <button class="close-btn" @onclick="CloseUserModal">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Name *</label>
                    <input class="form-control" @bind="editingUser.Name" />
                </div>
                <div class="form-group">
                    <label>Last Name *</label>
                    <input class="form-control" @bind="editingUser.LastName" />
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input class="form-control" type="email" @bind="editingUser.Email" />
                </div>
                <div class="form-group">
                    <label>Academic ID *</label>
                    <input class="form-control" @bind="editingUser.AcademicId" />
                </div>
                <div class="form-group">
                    <label>Password @(isEditing ? "(leave empty to keep current)" : "*")</label>
                    <input class="form-control" type="password" @bind="editingUser.Password"
                           placeholder="@(isEditing ? "Leave empty to keep current password" : "Enter password")" />
                </div>
                <div class="form-group">
                    <label>Role *</label>
                    <select class="form-control" @bind="editingUser.Role">
                        <option value="Admin">Admin</option>
                        <option value="Student">Student</option>
                        <option value="Teacher">Teacher</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" @onclick="CloseUserModal">Cancel</button>
                <button class="btn btn-primary" @onclick="SaveUser" disabled="@(!CanSaveUser())">
                    Save
                </button>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteModal)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Delete User</h3>
                <button class="close-btn" @onclick="CloseDeleteModal">×</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong>@deletingUser.Name @deletingUser.LastName</strong>?</p>
                <p class="warning-text">This action cannot be undone.</p>
                @if (cafeteriaWorkers.Any(cw => cw.StudentId == deletingUser.Id))
                {
                    <div class="warning-card">
                        <strong>⚠️ Cafeteria Worker</strong>
                        <p>This user is also a cafeteria worker. Their worker status will also be removed.</p>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" @onclick="CloseDeleteModal">Cancel</button>
                <button class="btn btn-danger" @onclick="DeleteUser">Delete</button>
            </div>
        </div>
    </div>
}

<!-- Cafeteria Worker Role Modal -->
@if (showCafeteriaWorkerModal)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>@(isAddingCafeteriaWorker ? "Add Cafeteria Worker" : "Remove Cafeteria Worker")</h3>
                <button class="close-btn" @onclick="CloseCafeteriaWorkerModal">×</button>
            </div>
            <div class="modal-body">
                @if (isAddingCafeteriaWorker)
                {
                    <div class="form-group">
                        <label>Role</label>
                        <select class="form-control" @bind="cafeteriaWorkerRole">
                            <option value="Volunteer">Volunteer</option>
                            <option value="Head Chef">Head Chef</option>
                            <option value="Assistant Chef">Assistant Chef</option>
                            <option value="Server">Server</option>
                            <option value="Cleaner">Cleaner</option>
                        </select>
                    </div>
                    <div class="info-card">
                        <h4>👨‍🍳 Cafeteria Worker Permissions</h4>
                        <ul>
                            <li>View and manage weekly food schedule</li>
                            <li>Add, edit, and delete meals</li>
                            <li>Vote on tomorrow's menu</li>
                            <li>See voting results</li>
                        </ul>
                    </div>
                }
                else
                {
                    <div class="warning-card">
                        <h4>Remove Cafeteria Worker</h4>
                        <p>Are you sure you want to remove <strong>@selectedUser.Name @selectedUser.LastName</strong> from cafeteria workers?</p>
                        <p>They will lose all cafeteria management permissions.</p>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" @onclick="CloseCafeteriaWorkerModal">Cancel</button>
                <button class="btn @(isAddingCafeteriaWorker ? "btn-success" : "btn-warning")"
                        @onclick="@(isAddingCafeteriaWorker? AddCafeteriaWorkerConfirm : RemoveCafeteriaWorkerConfirm)">
                    @(isAddingCafeteriaWorker ? "Add as Worker" : "Remove Worker")
                </button>
            </div>
        </div>
    </div>
}

@code {
    private List<User> users = new();
    private List<CafeteriaWorker> cafeteriaWorkers = new();
    private bool showUserModal = false;
    private bool isEditing = false;
    private User editingUser = new();
    private bool showDeleteModal = false;
    private User deletingUser = new();
    private bool showCafeteriaWorkerModal = false;
    private bool isAddingCafeteriaWorker = false;
    private User selectedUser = new();
    private string cafeteriaWorkerRole = "Volunteer";

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
        await LoadCafeteriaWorkers();
    }

    private async Task LoadUsers()
    {
        users = await DbContext.Users.OrderBy(u => u.Id).ToListAsync();
        StateHasChanged();
    }

    private async Task LoadCafeteriaWorkers()
    {
        cafeteriaWorkers = await DbContext.CafeteriaWorkers
            .Where(cw => cw.IsActive)
            .Include(cw => cw.Student)
            .ToListAsync();
        StateHasChanged();
    }

    private void ShowAddUserModal()
    {
        isEditing = false;
        editingUser = new User();
        showUserModal = true;
    }

    private void ShowEditUserModal(User user)
    {
        isEditing = true;
        editingUser = new User
        {
            Id = user.Id,
            Name = user.Name,
            LastName = user.LastName,
            Email = user.Email,
            AcademicId = user.AcademicId,
            Password = "", // Don't pre-fill password for security
            Role = user.Role,
            CreatedAt = user.CreatedAt
        };
        showUserModal = true;
    }

    private void CloseUserModal()
    {
        showUserModal = false;
    }

    private bool CanSaveUser()
    {
        return !string.IsNullOrWhiteSpace(editingUser.Name) &&
               !string.IsNullOrWhiteSpace(editingUser.LastName) &&
               !string.IsNullOrWhiteSpace(editingUser.Email) &&
               !string.IsNullOrWhiteSpace(editingUser.AcademicId) &&
               (!isEditing || !string.IsNullOrWhiteSpace(editingUser.Password));
    }

    private async Task SaveUser()
    {
        if (!CanSaveUser()) return;

        try
        {
            if (isEditing)
            {
                var user = await DbContext.Users.FindAsync(editingUser.Id);
                if (user != null)
                {
                    user.Name = editingUser.Name;
                    user.LastName = editingUser.LastName;
                    user.Email = editingUser.Email;
                    user.AcademicId = editingUser.AcademicId;
                    user.Role = editingUser.Role;

                    // Only update password if provided
                    if (!string.IsNullOrWhiteSpace(editingUser.Password))
                    {
                        user.Password = editingUser.Password;
                    }

                    await DbContext.SaveChangesAsync();
                }
            }
            else
            {
                editingUser.CreatedAt = DateTime.Now;
                DbContext.Users.Add(editingUser);
                await DbContext.SaveChangesAsync();
            }

            await LoadUsers();
            showUserModal = false;
            
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error saving user: {ex.Message}");
        }
    }

    private void ShowDeleteUserModal(User user)
    {
        deletingUser = user;
        showDeleteModal = true;
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
    }

    private async Task DeleteUser()
    {
        try
        {
            var user = await DbContext.Users.FindAsync(deletingUser.Id);
            if (user != null)
            {
                // Remove cafeteria worker status if exists
                var worker = await DbContext.CafeteriaWorkers
                    .FirstOrDefaultAsync(cw => cw.StudentId == user.Id);
                if (worker != null)
                {
                    DbContext.CafeteriaWorkers.Remove(worker);
                }

                DbContext.Users.Remove(user);
                await DbContext.SaveChangesAsync();
            }

            await LoadUsers();
            await LoadCafeteriaWorkers();
            showDeleteModal = false;
            
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error deleting user: {ex.Message}");
        }
    }

    // Cafeteria Worker Management
    private void AddCafeteriaWorker(User user)
    {
        selectedUser = user;
        isAddingCafeteriaWorker = true;
        cafeteriaWorkerRole = "Volunteer";
        showCafeteriaWorkerModal = true;
    }

    private void RemoveCafeteriaWorker(User user)
    {
        selectedUser = user;
        isAddingCafeteriaWorker = false;
        showCafeteriaWorkerModal = true;
    }

    private void CloseCafeteriaWorkerModal()
    {
        showCafeteriaWorkerModal = false;
        selectedUser = new User();
    }

    private async Task AddCafeteriaWorkerConfirm()
    {
        try
        {
            var existingWorker = await DbContext.CafeteriaWorkers
                .FirstOrDefaultAsync(cw => cw.StudentId == selectedUser.Id);

            if (existingWorker != null)
            {
                // Reactivate existing worker
                existingWorker.IsActive = true;
                existingWorker.Role = cafeteriaWorkerRole;
            }
            else
            {
                // Create new worker
                var worker = new CafeteriaWorker
                {
                    StudentId = selectedUser.Id,
                    Role = cafeteriaWorkerRole,
                    IsActive = true,
                    CreatedAt = DateTime.Now
                };
                DbContext.CafeteriaWorkers.Add(worker);
            }

            await DbContext.SaveChangesAsync();
            await LoadCafeteriaWorkers();
            CloseCafeteriaWorkerModal();
            
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error adding cafeteria worker: {ex.Message}");
        }
    }

    private async Task RemoveCafeteriaWorkerConfirm()
    {
        try
        {
            var worker = await DbContext.CafeteriaWorkers
                .FirstOrDefaultAsync(cw => cw.StudentId == selectedUser.Id);

            if (worker != null)
            {
                // Soft delete by setting inactive, or remove completely:
                DbContext.CafeteriaWorkers.Remove(worker); // Or set worker.IsActive = false;
                await DbContext.SaveChangesAsync();
            }

            await LoadCafeteriaWorkers();
            CloseCafeteriaWorkerModal();
            
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error removing cafeteria worker: {ex.Message}");
        }
    }
}

<style>
    .admin-users-page {
        padding: 2rem;
        font-family: 'Segoe UI', sans-serif;
        background: #f8fafc;
        min-height: 100vh;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

        .page-header h2 {
            margin: 0;
            color: #1e293b;
            font-size: 1.5rem;
            font-weight: 600;
        }

    .user-table-container {
        overflow-x: auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .user-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }

        .user-table th, .user-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .user-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #475569;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .user-table tr:hover {
            background: #f8fafc;
        }

    .role-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .role-admin {
        background: #fee2e2;
        color: #dc2626;
    }

    .role-student {
        background: #dbeafe;
        color: #2563eb;
    }

    .role-teacher {
        background: #f0fdf4;
        color: #16a34a;
    }

    .cafeteria-worker-toggle {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .worker-status {
        font-size: 0.875rem;
        font-weight: 500;
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
    }

        .worker-status.active {
            background: #f0fdf4;
            color: #16a34a;
        }

        .worker-status.inactive {
            background: #f1f5f9;
            color: #64748b;
        }

        .worker-status.na {
            background: #f8fafc;
            color: #94a3b8;
            font-style: italic;
        }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .btn {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
        border: none;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.8125rem;
    }

    .btn-primary {
        background: #3b82f6;
        color: white;
    }

        .btn-primary:hover:not(:disabled) {
            background: #2563eb;
            transform: translateY(-1px);
        }

    .btn-outline {
        background: white;
        color: #374151;
        border: 1px solid #d1d5db;
    }

        .btn-outline:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

    .btn-danger {
        background: #ef4444;
        color: white;
    }

        .btn-danger:hover {
            background: #dc2626;
        }

    .btn-success {
        background: #10b981;
        color: white;
    }

        .btn-success:hover {
            background: #059669;
        }

    .btn-warning {
        background: #f59e0b;
        color: white;
    }

        .btn-warning:hover {
            background: #d97706;
        }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        padding: 1rem;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        padding: 0;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: 0 20px 25px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .modal-header h3 {
            margin: 0;
            color: #1e293b;
            font-size: 1.25rem;
            font-weight: 600;
        }

    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #64748b;
        padding: 0.25rem;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

        .close-btn:hover {
            background: #f1f5f9;
            color: #374151;
        }

    .modal-footer {
        padding: 1.5rem;
        border-top: 1px solid #e2e8f0;
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
    }

    .modal-body {
        padding: 1.5rem;
        overflow-y: auto;
        flex: 1;
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

    .form-control {
        width: 100%;
        padding: 0.75rem;
        border-radius: 6px;
        border: 1px solid #d1d5db;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }

        .form-control:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

    .warning-text {
        color: #dc2626;
        font-weight: 500;
        margin: 0.5rem 0;
    }

    .warning-card {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
    }

        .warning-card h4 {
            margin: 0 0 0.5rem 0;
            color: #dc2626;
            font-size: 1rem;
        }

        .warning-card p {
            margin: 0.25rem 0;
            color: #7f1d1d;
            font-size: 0.875rem;
        }

    .info-card {
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
    }

        .info-card h4 {
            margin: 0 0 0.5rem 0;
            color: #0369a1;
            font-size: 1rem;
        }

        .info-card ul {
            margin: 0;
            padding-left: 1.25rem;
            color: #075985;
        }

        .info-card li {
            margin: 0.25rem 0;
            font-size: 0.875rem;
        }

    /* Responsive Design */
    @@media (max-width: 768px) {
        .admin-users-page {
            padding: 1rem;
        }

        .page-header {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
        }

        .action-buttons {
            flex-direction: column;
        }

        .cafeteria-worker-toggle {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .user-table {
            font-size: 0.875rem;
        }

            .user-table th, .user-table td {
                padding: 0.75rem 0.5rem;
            }
    }
</style>